{% extends 'base.html' %}
{% set title = 'Reservas' %}
{% block content %}

<!-- Header -->
<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h4 class="mb-1 text-white fw-bold"><i class="bi bi-calendar-event me-2"></i>Gestión de Reservas</h4>
        <p class="mb-0 text-white opacity-90">Administra las reservas de equipos y recursos</p>
      </div>
      <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#modalNuevaReserva" style="box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <i class="bi bi-plus-circle me-1"></i>Nueva Reserva
      </button>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
    <h6 class="mb-0 fw-bold" style="color: #2d6a4f;"><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h6>
  </div>
  <div class="card-body">
    <div class="input-group">
      <span class="input-group-text" style="background: #f8f9fa;"><i class="bi bi-search"></i></span>
      <input id="filtroRes" type="text" class="form-control" placeholder="Buscar por usuario o equipo...">
    </div>
  </div>
</div>

<!-- Tabla de Reservas -->
<div class="card border-0 shadow-sm">
  <div class="card-header border-0" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-list-check me-2"></i>Lista de Reservas</h6>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="tablaRes">
        <thead>
          <tr>
            <th>ID</th>
            <th><i class="bi bi-person me-1"></i>Usuario</th>
            <th><i class="bi bi-laptop me-1"></i>Equipo</th>
            <th><i class="bi bi-calendar-check me-1"></i>Inicio</th>
            <th><i class="bi bi-calendar-x me-1"></i>Fin</th>
            <th>Estado</th>
            <th><i class="bi bi-check-circle me-1"></i>Aprobación</th>
            <th>Acciones</th>
          </tr>
        </thead>
    <tbody>
      {% if reservas and reservas|length > 0 %}
        {% for r in reservas %}
        <tr data-id="{{ r.id }}" data-usuario="{{ r.usuario_nombre|lower }}" data-equipo="{{ r.equipo_nombre|lower }}">
          <td class="text-muted small">{{ r.id }}</td>
          <td>
            <div class="fw-semibold">{{ r.usuario_nombre }}</div>
            {% if r.usuario_programa %}
            <small class="text-muted">{{ r.usuario_programa }}</small>
            {% endif %}
          </td>
          <td>{{ r.equipo_nombre }}</td>
          <td>{{ r.fecha_inicio }}</td>
          <td>{{ r.fecha_fin }}</td>
          <td>
            {% if r.estado == 'activa' %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">ACTIVA</span>
            {% elif r.estado == 'programada' %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%);">PROGRAMADA</span>
            {% elif r.estado == 'aprobada' %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">APROBADA</span>
            {% elif r.estado == 'completada' %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">COMPLETADA</span>
            {% elif r.estado == 'cancelada' %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">CANCELADA</span>
            {% else %}
            <span class="badge rounded-pill px-3 py-2" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">{{ r.estado|upper }}</span>
            {% endif %}
          </td>
          <td>
            {% if r.respuesta_instructor == 'pendiente' %}
            <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pendiente</span>
            {% elif r.respuesta_instructor == 'aprobada' %}
            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Aprobada</span>
            {% if r.aprobada_por_nombre %}
            <small class="d-block text-muted mt-1">Por: {{ r.aprobada_por_nombre }}</small>
            {% endif %}
            {% elif r.respuesta_instructor == 'rechazada' %}
            <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Rechazada</span>
            {% if r.aprobada_por_nombre %}
            <small class="d-block text-muted mt-1">Por: {{ r.aprobada_por_nombre }}</small>
            {% endif %}
            {% if r.motivo_rechazo %}
            <small class="d-block text-danger mt-1" title="{{ r.motivo_rechazo }}"><i class="bi bi-info-circle"></i> Ver motivo</small>
            {% endif %}
            {% else %}
            <span class="badge bg-secondary">N/A</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if user.user_level >= 5 and user.a_cargo_inventario and r.respuesta_instructor == 'pendiente' %}
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-success btnAprobarRes" title="Aprobar reserva">
                <i class="bi bi-check-circle"></i>
              </button>
              <button class="btn btn-sm btn-danger btnRechazarRes" title="Rechazar reserva">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
            {% elif r.estado in ['programada','activa','aprobada'] and (user.user_level >= 3 or r.usuario_id == user.user_id) %}
            <button class="btn btn-sm btnCancelarRes" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none;">
              <i class="bi bi-x-circle me-1"></i>Cancelar
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
            No hay reservas registradas
          </td>
        </tr>
      {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Rechazar Reserva -->
<div class="modal fade" id="modalRechazarReserva" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
        <h5 class="modal-title text-white fw-bold"><i class="bi bi-x-circle me-2"></i>Rechazar Reserva</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Atención:</strong> Debes especificar un motivo de rechazo claro.
        </div>
        <div class="mb-3">
          <label for="motivoRechazo" class="form-label fw-semibold" style="color: #2d6a4f;">
            <i class="bi bi-chat-text me-1"></i>Motivo del rechazo *
          </label>
          <textarea id="motivoRechazo" class="form-control" rows="4" 
                    placeholder="Explica claramente el motivo del rechazo..." 
                    style="resize: none;"></textarea>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none;">
          <i class="bi bi-arrow-left me-1"></i>Cancelar
        </button>
        <button type="button" class="btn" id="btnConfirmarRechazo" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">
          <i class="bi bi-x-circle me-1"></i>Confirmar Rechazo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Nueva Reserva -->
<div class="modal fade" id="modalNuevaReserva" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
        <h5 class="modal-title text-white fw-bold"><i class="bi bi-calendar-plus me-2"></i>Nueva Reserva</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold" style="color: #2d6a4f;"><i class="bi bi-laptop me-1"></i>Equipo *</label>
            <select id="equipoId" class="form-select" {% if not equipos or equipos|length == 0 %}disabled{% endif %}>
              <option value="">-- Seleccione un equipo --</option>
              {% if equipos and equipos|length > 0 %}
                {% for equipo in equipos %}
                <option value="{{ equipo.id }}">
                  {{ equipo.nombre }} ({{ equipo.tipo }}) - {{ equipo.estado }}
                </option>
                {% endfor %}
              {% else %}
                <option value="">No hay equipos disponibles</option>
              {% endif %}
            </select>
            <small class="text-muted">
              {% if equipos and equipos|length > 0 %}
                <i class="bi bi-info-circle"></i> Seleccione el equipo que desea reservar
              {% else %}
                <i class="bi bi-exclamation-triangle"></i> No hay equipos disponibles para reservar. Registre equipos primero.
              {% endif %}
            </small>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold" style="color: #2d6a4f;"><i class="bi bi-calendar-check me-1"></i>Fecha y Hora de Inicio *</label>
            <input type="datetime-local" id="fechaInicio" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold" style="color: #2d6a4f;"><i class="bi bi-calendar-x me-1"></i>Fecha y Hora de Fin *</label>
            <input type="datetime-local" id="fechaFin" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold" style="color: #2d6a4f;"><i class="bi bi-chat-text me-1"></i>Propósito *</label>
            <textarea id="proposito" class="form-control" rows="4" placeholder="Describe el propósito de la reserva..." style="resize: none;"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none;">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <button type="button" class="btn" id="btnCrearReserva" style="background: linear-gradient(135deg, #00b894 0%, #009b7d 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);">
          <i class="bi bi-check-circle me-1"></i>Crear Reserva
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const resFilter = document.getElementById('filtroRes');
  const resBody = document.querySelector('#tablaRes tbody');
  let reservaIdTemporal = null;

  resFilter.addEventListener('input', ()=>{
    const t=(resFilter.value||'').toLowerCase();
    [...resBody.rows].forEach(r=>{
      const ok = r.dataset.usuario.includes(t)||r.dataset.equipo.includes(t);
      r.classList.toggle('d-none', !ok);
    });
  });

  // Event delegation para todos los botones en la tabla
  resBody.addEventListener('click', async (ev)=>{
    // Aprobar reserva
    if(ev.target.closest('.btnAprobarRes')){
      const btn = ev.target.closest('.btnAprobarRes');
      const tr = btn.closest('tr');
      const id = tr?.dataset?.id;
      if(!id) return;
      if(!confirm('¿Aprobar la reserva '+id+'?')) return;
      await responderReserva(id, 'aprobada');
      return;
    }

    // Rechazar reserva (mostrar modal)
    if(ev.target.closest('.btnRechazarRes')){
      const btn = ev.target.closest('.btnRechazarRes');
      const tr = btn.closest('tr');
      const id = tr?.dataset?.id;
      if(!id) return;
      reservaIdTemporal = id;
      document.getElementById('motivoRechazo').value = '';
      const modal = new bootstrap.Modal(document.getElementById('modalRechazarReserva'));
      modal.show();
      return;
    }

    // Cancelar reserva vía API
    if(ev.target.closest('.btnCancelarRes')){
      const btn = ev.target.closest('.btnCancelarRes');
      const tr = btn.closest('tr');
      const id = tr?.dataset?.id;
      if(!id) return;
      if(!confirm('¿Cancelar la reserva '+id+'?')) return;
      const token = localStorage.getItem('jwt');
      if(!token){ alert('Inicie sesión API (icono llave en la barra superior)'); return; }
      try{
        const res = await fetch('/api/reservas/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        const data = await res.json();
        if(res.ok){ tr.remove(); }
        else{ alert(data?.message || 'No fue posible cancelar la reserva'); }
      }catch(e){ alert('Error cancelando: '+e.message); }
      return;
    }
  });

  // Confirmar rechazo desde el modal
  document.getElementById('btnConfirmarRechazo').addEventListener('click', async ()=>{
    const motivo = document.getElementById('motivoRechazo').value.trim();
    if(!motivo){
      alert('Debes especificar un motivo para el rechazo');
      return;
    }
    bootstrap.Modal.getInstance(document.getElementById('modalRechazarReserva')).hide();
    await responderReserva(reservaIdTemporal, 'rechazada', motivo);
  });

  // Función para aprobar/rechazar reserva
  async function responderReserva(reservaId, respuesta, motivo = null){
    try{
      const res = await fetch('/api/reservas/'+reservaId+'/responder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          respuesta: respuesta,
          motivo_rechazo: motivo
        })
      });
      const data = await res.json();
      if(res.ok){
        alert(data.message || (respuesta === 'aprobada' ? 'Reserva aprobada' : 'Reserva rechazada'));
        location.reload();
      } else {
        alert('Error: ' + (data.message || 'No fue posible procesar la respuesta'));
      }
    }catch(e){
      alert('Error procesando respuesta: ' + e.message);
    }
  }

  // Crear nueva reserva
  document.getElementById('btnCrearReserva').addEventListener('click', async ()=>{
    const equipoId = document.getElementById('equipoId').value.trim();
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const proposito = document.getElementById('proposito').value.trim();

    if(!equipoId || !fechaInicio || !fechaFin || !proposito){
      alert('Todos los campos son obligatorios');
      return;
    }

    // Convertir formato datetime-local a MySQL datetime
    const inicio = fechaInicio.replace('T', ' ') + ':00';
    const fin = fechaFin.replace('T', ' ') + ':00';

    try{
      const res = await fetch('/reservas/crear', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          equipo_id: equipoId,
          fecha_inicio: inicio,
          fecha_fin: fin,
          proposito: proposito
        })
      });

      const data = await res.json();
      if(data.success){
        alert('Reserva creada exitosamente');
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    }catch(e){
      alert('Error creando reserva: ' + e.message);
    }
  });

  // Auto-abrir modal si viene desde laboratorio_detalle con equipo preseleccionado
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const equipoId = urlParams.get('equipo_id');
    const equipoNombre = urlParams.get('equipo_nombre');
    
    if (equipoId) {
      // Preseleccionar el equipo en el select
      const selectEquipo = document.getElementById('equipoId');
      if (selectEquipo) {
        selectEquipo.value = equipoId;
        
        // Si el equipo no existe en la lista, agregarlo temporalmente
        if (!selectEquipo.value) {
          const option = document.createElement('option');
          option.value = equipoId;
          option.textContent = equipoNombre || `Equipo ${equipoId}`;
          option.selected = true;
          selectEquipo.appendChild(option);
        }
      }
      
      // Agregar mensaje informativo al modal
      const modalTitle = document.querySelector('#modalNuevaReserva .modal-title');
      if (modalTitle && equipoNombre) {
        const badge = document.createElement('span');
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = `<i class="bi bi-check-circle me-1"></i>Equipo seleccionado`;
        modalTitle.appendChild(badge);
      }
      
      // Abrir el modal automáticamente
      const modal = new bootstrap.Modal(document.getElementById('modalNuevaReserva'));
      modal.show();
      
      // Limpiar los parámetros de la URL sin recargar la página
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  });
</script>
{% endblock %}
