{% extends 'base.html' %}
{% set title = 'Backup de Base de Datos' %}
{% block content %}

<style>
/* Dise√±o Moderno para Backups */
.backup-modern-header {
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 50%, #52b788 100%);
    border-radius: 20px;
    padding: 35px 40px;
    margin-bottom: 30px;
    box-shadow: 0 10px 40px rgba(45, 106, 79, 0.3);
    color: white;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 25px;
}

.backup-modern-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
}

.backup-modern-header h1 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 5px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.backup-modern-header p {
    font-size: 1rem;
    opacity: 0.95;
    margin: 0;
}

.backup-modern-header .icon-container {
    font-size: 3.5rem;
    animation: pulse 2s ease-in-out infinite;
    flex-shrink: 0;
}

.backup-modern-header .content-container {
    flex: 1;
    z-index: 1;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; }
}

.modern-card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.08);
    border: 1px solid rgba(45, 106, 79, 0.1);
    transition: all 0.3s ease;
    margin-bottom: 25px;
}

.modern-card:hover {
    box-shadow: 0 8px 35px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.modern-card-header {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(45, 106, 79, 0.1);
}

.modern-card-header i {
    font-size: 2rem;
    margin-right: 15px;
    background: linear-gradient(135deg, #2d6a4f, #52b788);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.modern-card-header h4 {
    margin: 0;
    font-weight: 700;
    color: #2d6a4f;
}

.btn-create-modern {
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
    color: white;
    border: none;
    padding: 18px 35px;
    border-radius: 15px;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 5px 20px rgba(45, 106, 79, 0.3);
    width: 100%;
    margin-top: 20px;
}

.btn-create-modern:hover {
    background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(45, 106, 79, 0.4);
    color: white;
}

.btn-create-modern:active {
    transform: translateY(0);
}

.info-box-modern {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 4px solid #2d6a4f;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.info-box-modern i {
    color: #2d6a4f;
    font-size: 1.3rem;
}

.feature-list {
    list-style: none;
    padding: 0;
    margin: 20px 0 0 0;
}

.feature-list li {
    padding: 12px 0;
    display: flex;
    align-items: center;
    font-size: 0.95rem;
    color: #333;
    transition: all 0.2s ease;
}

.feature-list li:hover {
    padding-left: 10px;
    color: #2d6a4f;
}

.feature-list li i {
    font-size: 1.2rem;
    margin-right: 12px;
    color: #52b788;
}

.backup-item-modern {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid rgba(45, 106, 79, 0.1);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.backup-item-modern:hover {
    border-color: rgba(45, 106, 79, 0.3);
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    transform: translateX(5px);
}

.backup-icon-modern {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #2d6a4f 0%, #52b788 100%);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
    box-shadow: 0 4px 15px rgba(45, 106, 79, 0.3);
}

.backup-info h6 {
    font-weight: 700;
    color: #2d6a4f;
    margin-bottom: 8px;
    font-size: 1rem;
}

.backup-meta {
    display: flex;
    gap: 15px;
    font-size: 0.85rem;
    color: #6c757d;
}

.backup-meta i {
    color: #52b788;
}

.btn-action-modern {
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid;
}

.btn-action-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}

.btn-download-modern {
    background: white;
    color: #0d6efd;
    border-color: #0d6efd;
}

.btn-download-modern:hover {
    background: #0d6efd;
    color: white;
}

.btn-restore-modern {
    background: white;
    color: #198754;
    border-color: #198754;
}

.btn-restore-modern:hover {
    background: #198754;
    color: white;
}

.btn-delete-modern {
    background: white;
    color: #dc3545;
    border-color: #dc3545;
}

.btn-delete-modern:hover {
    background: #dc3545;
    color: white;
}

.empty-state-modern {
    text-align: center;
    padding: 60px 20px;
}

.empty-state-modern i {
    font-size: 5rem;
    color: #dee2e6;
    margin-bottom: 20px;
    animation: float 3s ease-in-out infinite;
}

.recommendations-modern {
    margin-top: 30px;
}

.recommendation-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    border-left: 5px solid;
    box-shadow: 0 3px 15px rgba(0,0,0,0.05);
    height: 100%;
}

.recommendation-card.success {
    border-left-color: #198754;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}

.recommendation-card.warning {
    border-left-color: #ffc107;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
}

.recommendation-card h6 {
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.recommendation-card ul {
    margin: 0;
    padding-left: 20px;
}

.recommendation-card li {
    margin-bottom: 8px;
    font-size: 0.9rem;
}

/* Modales Modernos */
#modalRestore.modal,
#modalDelete.modal {
    z-index: 9999 !important;
}

#modalRestore .modal-dialog,
#modalDelete .modal-dialog {
    z-index: 10000 !important;
}

#modalRestore .modal-content,
#modalDelete .modal-content {
    z-index: 10001 !important;
    position: relative;
    border-radius: 20px;
    border: none;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-backdrop {
    z-index: 9998 !important;
}

#modalRestore button,
#modalDelete button,
#modalRestore .btn,
#modalDelete .btn {
    pointer-events: auto !important;
    position: relative;
    z-index: 10002 !important;
    border-radius: 10px;
    padding: 12px 25px;
    font-weight: 600;
}

.modal-header {
    border-radius: 20px 20px 0 0;
    padding: 25px 30px;
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    padding: 20px 30px;
    border-top: 1px solid rgba(0,0,0,0.1);
}

/* Animaciones de entrada */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modern-card {
    animation: slideInUp 0.5s ease-out;
}

.backup-item-modern {
    animation: slideInUp 0.3s ease-out;
}

.backup-item-modern:nth-child(1) { animation-delay: 0.1s; }
.backup-item-modern:nth-child(2) { animation-delay: 0.2s; }
.backup-item-modern:nth-child(3) { animation-delay: 0.3s; }
.backup-item-modern:nth-child(4) { animation-delay: 0.4s; }
.backup-item-modern:nth-child(5) { animation-delay: 0.5s; }
</style>

<div class="backup-modern-header">
    <div class="icon-container">
        <i class="bi bi-database"></i>
    </div>
    <div class="content-container">
        <h1><i class="bi bi-shield-check me-2"></i>Gesti√≥n de Backups</h1>
        <p>Sistema de respaldo y restauraci√≥n de base de datos con seguridad empresarial</p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <div class="col-lg-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <i class="bi bi-plus-circle"></i>
                <h4>Crear Nuevo Backup</h4>
            </div>
            
            <div class="info-box-modern">
                <i class="bi bi-info-circle me-2"></i>
                <small><strong>Nota:</strong> El proceso puede tardar varios minutos seg√∫n el tama√±o de la base de datos.</small>
            </div>

            <form method="POST" action="{{ url_for('backup') }}">
                <input type="hidden" name="action" value="create">
                <button type="submit" class="btn-create-modern">
                    <i class="bi bi-cloud-arrow-up me-2"></i>Crear Backup Ahora
                </button>
            </form>

            <div class="mt-4">
                <h6 style="color: #2d6a4f; font-weight: 700; margin-bottom: 15px;">
                    <i class="bi bi-check2-circle me-2"></i>Caracter√≠sticas
                </h6>
                <ul class="feature-list">
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        Todas las tablas incluidas
                    </li>
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        Procedimientos y triggers
                    </li>
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        Formato SQL est√°ndar
                    </li>
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        Compresi√≥n GZIP autom√°tica
                    </li>
                    <li>
                        <i class="bi bi-check-circle-fill"></i>
                        Timestamp en nombre de archivo
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="modern-card">
            <div class="modern-card-header">
                <i class="bi bi-archive"></i>
                <h4>Backups Disponibles</h4>
                <span class="badge bg-success ms-auto" style="font-size: 1rem; padding: 8px 15px; border-radius: 10px;">{{ backups|length }}</span>
            </div>

            {% if backups %}
                {% for backup in backups %}
                <div class="backup-item-modern">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="backup-icon-modern">
                                <i class="bi bi-file-earmark-zip"></i>
                            </div>
                        </div>
                        <div class="col backup-info">
                            <h6>{{ backup.nombre }}</h6>
                            <div class="backup-meta">
                                <span><i class="bi bi-calendar3 me-1"></i>{{ backup.fecha }}</span>
                                <span><i class="bi bi-hdd me-1"></i>{{ backup.tama√±o }}</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('download_backup', filename=backup.nombre) }}" 
                                   class="btn btn-sm btn-action-modern btn-download-modern"
                                   title="Descargar backup">
                                    <i class="bi bi-download"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-action-modern btn-restore-modern" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalRestore"
                                        data-backup="{{ backup.nombre }}"
                                        title="Restaurar backup">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-action-modern btn-delete-modern"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalDelete"
                                        data-backup="{{ backup.nombre }}"
                                        title="Eliminar backup">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state-modern">
                    <i class="bi bi-inbox"></i>
                    <h5 style="color: #6c757d; font-weight: 600;">No hay backups disponibles</h5>
                    <p class="text-muted">Crea tu primer backup usando el bot√≥n de la izquierda</p>
                </div>
            {% endif %}
        </div>

        <div class="recommendations-modern">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="recommendation-card success">
                        <h6><i class="bi bi-check-circle-fill text-success"></i>Buenas Pr√°cticas</h6>
                        <ul>
                            <li>Crear backups diarios autom√°ticos</li>
                            <li>Mantener al menos 7 backups hist√≥ricos</li>
                            <li>Verificar integridad peri√≥dicamente</li>
                            <li>Guardar copias en ubicaci√≥n externa</li>
                            <li>Documentar cada restauraci√≥n</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="recommendation-card warning">
                        <h6><i class="bi bi-exclamation-triangle-fill text-warning"></i>Precauciones</h6>
                        <ul>
                            <li>Restaurar cierra todas las conexiones</li>
                            <li>Los datos actuales se sobrescriben</li>
                            <li>El proceso no se puede deshacer</li>
                            <li>Notifica a los usuarios antes</li>
                            <li>Verifica el backup antes de restaurar</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Restauraci√≥n -->
<div class="modal fade" id="modalRestore" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Restauraci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    <strong>¬°ADVERTENCIA!</strong> Esta acci√≥n sobrescribir√° todos los datos actuales de la base de datos.
                </div>
                <p>¬øEst√°s seguro de que deseas restaurar este backup?</p>
                <p class="mb-0"><strong>Archivo:</strong> <span id="backupFileName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('backup') }}" style="display: inline;">
                    <input type="hidden" name="action" value="restore">
                    <input type="hidden" name="backup_file" id="backupFileInput">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise me-2"></i>S√≠, Restaurar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Eliminaci√≥n -->
<div class="modal fade" id="modalDelete" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-trash me-2"></i>Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>¬°ATENCI√ìN!</strong> Esta acci√≥n no se puede deshacer.
                </div>
                <p>¬øEst√°s seguro de que deseas eliminar este backup?</p>
                <p class="mb-0"><strong>Archivo:</strong> <span id="deleteFileName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('backup') }}" style="display: inline;">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="backup_file" id="deleteFileInput">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>S√≠, Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay se crea din√°micamente con JavaScript -->

<script>
    // Pasar nombre del backup a los modales
    document.addEventListener('DOMContentLoaded', function() {
        let loadingOverlay = null;
        let loadingTimer = null;
        let loadingSeconds = 0;
        
        // Funci√≥n para crear el overlay din√°micamente
        function createLoadingOverlay() {
            if (loadingOverlay) return; // Ya existe
            
            loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.innerHTML = `
                <div class="text-center text-white" style="position: relative; max-width: 500px; padding: 40px; background: rgba(45, 106, 79, 0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <button id="emergencyClose" onclick="location.reload()" 
                            style="display: none; position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        <i class="bi bi-x-circle me-1"></i>Cerrar y Recargar
                    </button>
                    <div class="spinner-border mb-3" role="status" style="width: 4rem; height: 4rem; border-color: white; border-right-color: transparent;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <h4 id="loadingText" style="color: white; font-weight: 700;">Procesando backup...</h4>
                    <p class="mb-0" style="color: rgba(255,255,255,0.9);">Por favor espera, esto puede tardar varios minutos</p>
                    <small class="d-block mt-3" id="loadingTimer" style="color: rgba(255,255,255,0.7); font-size: 16px; font-weight: 600;"></small>
                </div>
            `;
            // NO agregarlo al DOM todav√≠a
        }
        
        // Funci√≥n para mostrar loading con timer
        function showLoading(text) {
            console.log('üîÑ Mostrando loading:', text);
            
            // Crear el overlay si no existe
            createLoadingOverlay();
            
            // Configurar estilos
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = '0';
            loadingOverlay.style.left = '0';
            loadingOverlay.style.width = '100%';
            loadingOverlay.style.height = '100%';
            loadingOverlay.style.background = 'rgba(0,0,0,0.85)';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.zIndex = '99999';
            
            // Agregar al DOM
            document.body.appendChild(loadingOverlay);
            console.log('‚úÖ Loading overlay agregado al DOM');
            
            document.getElementById('loadingText').textContent = text;
            document.getElementById('emergencyClose').style.display = 'none';
            loadingSeconds = 0;
            
            // Iniciar timer
            loadingTimer = setInterval(() => {
                loadingSeconds++;
                const minutes = Math.floor(loadingSeconds / 60);
                const seconds = loadingSeconds % 60;
                document.getElementById('loadingTimer').textContent = 
                    `Tiempo transcurrido: ${minutes}m ${seconds}s`;
                
                // Mostrar bot√≥n de emergencia despu√©s de 30 segundos
                if (loadingSeconds >= 30) {
                    document.getElementById('emergencyClose').style.display = 'block';
                }
            }, 1000);
        }
        
        // Funci√≥n para ocultar loading
        function hideLoading() {
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
                console.log('‚úÖ Loading overlay removido del DOM');
            }
            if (loadingTimer) {
                clearInterval(loadingTimer);
                loadingTimer = null;
            }
        }
        
        // Modal de restauraci√≥n - Cargar datos
        const modalRestore = document.getElementById('modalRestore');
        if (modalRestore) {
            modalRestore.addEventListener('show.bs.modal', function(event) {
                // Cargar nombre del backup en el modal
                const button = event.relatedTarget;
                const backupName = button.getAttribute('data-backup');
                document.getElementById('backupFileName').textContent = backupName;
                document.getElementById('backupFileInput').value = backupName;
            });
            
            // Manejar submit del formulario de restauraci√≥n
            const restoreForm = modalRestore.querySelector('form');
            if (restoreForm) {
                restoreForm.addEventListener('submit', function(e) {
                    // Cerrar el modal inmediatamente
                    const modal = bootstrap.Modal.getInstance(modalRestore);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Limpiar backdrop y mostrar loading despu√©s de que el modal se cierre
                    setTimeout(() => {
                        // Remover todos los backdrops
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // Restaurar body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        // Mostrar overlay de carga
                        showLoading('Restaurando backup...');
                    }, 350);
                });
            }
        }
        
        // Modal de eliminaci√≥n - Cargar datos
        const modalDelete = document.getElementById('modalDelete');
        if (modalDelete) {
            modalDelete.addEventListener('show.bs.modal', function(event) {
                // Cargar nombre del backup en el modal
                const button = event.relatedTarget;
                const backupName = button.getAttribute('data-backup');
                document.getElementById('deleteFileName').textContent = backupName;
                document.getElementById('deleteFileInput').value = backupName;
            });
            
            // Manejar submit del formulario de eliminaci√≥n
            const deleteForm = modalDelete.querySelector('form');
            if (deleteForm) {
                deleteForm.addEventListener('submit', function(e) {
                    // Cerrar el modal inmediatamente
                    const modal = bootstrap.Modal.getInstance(modalDelete);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Limpiar backdrop y mostrar loading despu√©s de que el modal se cierre
                    setTimeout(() => {
                        // Remover todos los backdrops
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // Restaurar body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        // Mostrar overlay de carga
                        showLoading('Eliminando backup...');
                    }, 350);
                });
            }
        }
        
        // Manejar submit del formulario de crear backup
        const createForms = document.querySelectorAll('form');
        createForms.forEach(form => {
            const actionInput = form.querySelector('input[name="action"][value="create"]');
            if (actionInput) {
                form.addEventListener('submit', function(e) {
                    showLoading('Creando backup...');
                });
            }
        });
    });
</script>

{% endblock %}
