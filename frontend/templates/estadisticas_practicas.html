{% extends "base.html" %}

{% block title %}Estad铆sticas y Monitoreo - GIL{% endblock %}

{% block content %}
<!-- Header -->
<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-1 text-white fw-bold"><i class="bi bi-graph-up-arrow me-2"></i>Estad铆sticas y Monitoreo</h4>
        <p class="mb-0 text-white opacity-90">An谩lisis de uso y ocupaci贸n de laboratorios</p>
      </div>
      <a href="{{ url_for('practicas') }}" class="btn btn-light">
        <i class="bi bi-arrow-left me-1"></i>Volver a Reservas
      </a>
    </div>
  </div>
</div>

<!-- Estad铆sticas Generales -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <p class="text-muted small mb-1">Total Reservas</p>
            <h3 class="mb-0 fw-bold" id="statTotalPracticas">-</h3>
          </div>
          <div class="bg-primary bg-opacity-10 p-2 rounded">
            <i class="bi bi-journal-text text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <p class="text-muted small mb-1">Programadas</p>
            <h3 class="mb-0 fw-bold text-warning" id="statProgramadas">-</h3>
          </div>
          <div class="bg-warning bg-opacity-10 p-2 rounded">
            <i class="bi bi-clock-history text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <p class="text-muted small mb-1">En Curso</p>
            <h3 class="mb-0 fw-bold text-info" id="statEnCurso">-</h3>
          </div>
          <div class="bg-info bg-opacity-10 p-2 rounded">
            <i class="bi bi-play-circle text-info fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <p class="text-muted small mb-1">Completadas</p>
            <h3 class="mb-0 fw-bold text-success" id="statCompletadas">-</h3>
          </div>
          <div class="bg-success bg-opacity-10 p-2 rounded">
            <i class="bi bi-check-circle text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Laboratorios M谩s Usados -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-white border-0 py-3">
    <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Laboratorios M谩s Usados</h5>
  </div>
  <div class="card-body">
    <div id="labsMasUsados" class="list-group list-group-flush">
      <div class="text-center py-4 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Cargando datos...
      </div>
    </div>
  </div>
</div>

<!-- Ocupaci贸n de Laboratorios en Tiempo Real -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white border-0 py-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0"><i class="bi bi-building me-2"></i>Ocupaci贸n de Laboratorios</h5>
      <div class="d-flex gap-2 align-items-center">
        <div class="input-group input-group-sm" style="width: 250px;">
          <span class="input-group-text bg-white">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="buscarLaboratorio" 
                 placeholder="Buscar laboratorio..." 
                 onkeyup="filtrarLaboratorios()">
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="cargarOcupacion()">
          <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div id="ocupacionLaboratorios" class="row g-3">
      <div class="col-12 text-center py-4 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Cargando ocupaci贸n...
      </div>
    </div>
    
    <!-- Paginaci贸n -->
    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
      <div class="text-muted small">
        Mostrando <span id="labsInicio">0</span> - <span id="labsFin">0</span> de <span id="labsTotal">0</span> laboratorios
      </div>
      <nav>
        <ul class="pagination pagination-sm mb-0" id="paginacionLabs">
        </ul>
      </nav>
    </div>
  </div>
</div>

<script>
// Cargar estad铆sticas al cargar la p谩gina
document.addEventListener('DOMContentLoaded', function() {
    cargarEstadisticas();
    cargarOcupacion();
});

async function cargarEstadisticas() {
    try {
        const response = await fetch('/api/practicas/estadisticas');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.estadisticas;
            
            document.getElementById('statTotalPracticas').textContent = stats.total_practicas || 0;
            document.getElementById('statProgramadas').textContent = stats.practicas_programadas || 0;
            document.getElementById('statEnCurso').textContent = stats.practicas_en_curso || 0;
            document.getElementById('statCompletadas').textContent = stats.practicas_completadas || 0;
            
            mostrarLabsMasUsados(stats.laboratorios_mas_usados || []);
        } else {
            console.error('Error en respuesta:', data.message);
        }
    } catch (error) {
        console.error('Error cargando estad铆sticas:', error);
    }
}

function mostrarLabsMasUsados(laboratorios) {
    const container = document.getElementById('labsMasUsados');
    
    if (laboratorios.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No hay datos disponibles
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    laboratorios.forEach((lab, index) => {
        const porcentaje = laboratorios[0].total_practicas > 0 
            ? Math.round((lab.total_practicas / laboratorios[0].total_practicas) * 100)
            : 0;
        
        const medalla = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : '';
        
        const item = document.createElement('div');
        item.className = 'list-group-item border-0 px-0';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <span class="me-2">${medalla}</span>
                    <strong>${lab.nombre}</strong>
                </div>
                <span class="badge bg-primary rounded-pill">${lab.total_practicas} reservas</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: ${porcentaje}%" 
                     aria-valuenow="${porcentaje}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Variables globales para paginaci贸n y filtrado
let laboratoriosTodos = [];
let laboratoriosFiltrados = [];
let paginaActualLabs = 1;
const labsPorPagina = 6;

async function cargarOcupacion() {
    try {
        const response = await fetch('/api/practicas/ocupacion-laboratorios');
        const data = await response.json();
        
        if (data.success) {
            laboratoriosTodos = data.laboratorios || [];
            laboratoriosFiltrados = [...laboratoriosTodos];
            paginaActualLabs = 1;
            mostrarOcupacion();
        }
    } catch (error) {
        console.error('Error cargando ocupaci贸n:', error);
    }
}

function filtrarLaboratorios() {
    const busqueda = document.getElementById('buscarLaboratorio').value.toLowerCase();
    
    laboratoriosFiltrados = laboratoriosTodos.filter(lab => {
        return lab.nombre.toLowerCase().includes(busqueda);
    });
    
    paginaActualLabs = 1;
    mostrarOcupacion();
}

function mostrarOcupacion() {
    const container = document.getElementById('ocupacionLaboratorios');
    
    if (laboratoriosFiltrados.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No se encontraron laboratorios
            </div>
        `;
        actualizarInfoPaginacion(0, 0, 0);
        document.getElementById('paginacionLabs').innerHTML = '';
        return;
    }
    
    // Calcular 铆ndices de paginaci贸n
    const inicio = (paginaActualLabs - 1) * labsPorPagina;
    const fin = Math.min(inicio + labsPorPagina, laboratoriosFiltrados.length);
    const laboratoriosPagina = laboratoriosFiltrados.slice(inicio, fin);
    
    container.innerHTML = '';
    
    laboratoriosPagina.forEach(lab => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        
        let estadoBadge = '';
        let estadoColor = '';
        let estadoIcono = '';
        
        if (lab.estado_ocupacion === 'ocupado') {
            estadoBadge = 'bg-danger';
            estadoColor = 'border-danger';
            estadoIcono = '';
        } else if (lab.estado_ocupacion === 'reservado') {
            estadoBadge = 'bg-warning';
            estadoColor = 'border-warning';
            estadoIcono = '';
        } else {
            estadoBadge = 'bg-success';
            estadoColor = 'border-success';
            estadoIcono = '';
        }
        
        col.innerHTML = `
            <div class="card border-2 ${estadoColor} h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="mb-0">${estadoIcono} ${lab.nombre}</h6>
                        <span class="badge ${estadoBadge}">${lab.estado_ocupacion}</span>
                    </div>
                    
                    <div class="small text-muted">
                        ${lab.practicas_en_curso > 0 ? `
                            <div class="mb-2">
                                <i class="bi bi-play-circle me-1"></i>
                                <strong>${lab.practicas_en_curso}</strong> en curso
                            </div>
                        ` : ''}
                        
                        ${lab.practicas_programadas_hoy > 0 ? `
                            <div class="mb-2">
                                <i class="bi bi-calendar-check me-1"></i>
                                <strong>${lab.practicas_programadas_hoy}</strong> reservadas hoy
                            </div>
                        ` : ''}
                        
                        ${lab.proxima_practica ? `
                            <div class="mb-2">
                                <i class="bi bi-clock me-1"></i>
                                Pr贸xima reserva: ${lab.proxima_practica}
                            </div>
                        ` : ''}
                        
                        ${!lab.practicas_en_curso && !lab.practicas_programadas_hoy && !lab.proxima_practica ? `
                            <div class="text-success">
                                <i class="bi bi-check-circle me-1"></i>
                                Disponible
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
    
    // Actualizar informaci贸n de paginaci贸n
    actualizarInfoPaginacion(inicio + 1, fin, laboratoriosFiltrados.length);
    generarPaginacionLabs();
}

function actualizarInfoPaginacion(inicio, fin, total) {
    document.getElementById('labsInicio').textContent = inicio;
    document.getElementById('labsFin').textContent = fin;
    document.getElementById('labsTotal').textContent = total;
}

function generarPaginacionLabs() {
    const totalPaginas = Math.ceil(laboratoriosFiltrados.length / labsPorPagina);
    const paginacion = document.getElementById('paginacionLabs');
    
    if (totalPaginas <= 1) {
        paginacion.innerHTML = '';
        return;
    }
    
    paginacion.innerHTML = '';
    
    // Bot贸n anterior
    const liPrev = document.createElement('li');
    liPrev.className = `page-item ${paginaActualLabs === 1 ? 'disabled' : ''}`;
    liPrev.innerHTML = `<a class="page-link" href="#" onclick="cambiarPaginaLabs(${paginaActualLabs - 1}); return false;">芦</a>`;
    paginacion.appendChild(liPrev);
    
    // P谩ginas
    let inicio = Math.max(1, paginaActualLabs - 2);
    let fin = Math.min(totalPaginas, paginaActualLabs + 2);
    
    if (inicio > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPaginaLabs(1); return false;">1</a>`;
        paginacion.appendChild(li);
        
        if (inicio > 2) {
            const liDots = document.createElement('li');
            liDots.className = 'page-item disabled';
            liDots.innerHTML = `<span class="page-link">...</span>`;
            paginacion.appendChild(liDots);
        }
    }
    
    for (let i = inicio; i <= fin; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === paginaActualLabs ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPaginaLabs(${i}); return false;">${i}</a>`;
        paginacion.appendChild(li);
    }
    
    if (fin < totalPaginas) {
        if (fin < totalPaginas - 1) {
            const liDots = document.createElement('li');
            liDots.className = 'page-item disabled';
            liDots.innerHTML = `<span class="page-link">...</span>`;
            paginacion.appendChild(liDots);
        }
        
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPaginaLabs(${totalPaginas}); return false;">${totalPaginas}</a>`;
        paginacion.appendChild(li);
    }
    
    // Bot贸n siguiente
    const liNext = document.createElement('li');
    liNext.className = `page-item ${paginaActualLabs === totalPaginas ? 'disabled' : ''}`;
    liNext.innerHTML = `<a class="page-link" href="#" onclick="cambiarPaginaLabs(${paginaActualLabs + 1}); return false;">禄</a>`;
    paginacion.appendChild(liNext);
}

function cambiarPaginaLabs(nuevaPagina) {
    const totalPaginas = Math.ceil(laboratoriosFiltrados.length / labsPorPagina);
    if (nuevaPagina < 1 || nuevaPagina > totalPaginas) return;
    
    paginaActualLabs = nuevaPagina;
    mostrarOcupacion();
    
    // Scroll suave a la secci贸n de ocupaci贸n
    document.getElementById('ocupacionLaboratorios').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}
