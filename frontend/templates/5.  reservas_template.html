{% extends "base.html" %}

{% block title %}Reservas - Centro Minero SENA{% endblock %}
{% block page_title %}Gestión de Reservas{% endblock %}

{% block extra_css %}
<style>
    .reservation-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        margin-bottom: 20px;
        border-left: 5px solid var(--sena-green);
    }

    .reservation-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .reservation-card.programada {
        border-left-color: #17a2b8;
    }

    .reservation-card.activa {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
    }

    .reservation-card.completada {
        border-left-color: #6c757d;
        opacity: 0.8;
    }

    .reservation-card.cancelada {
        border-left-color: #dc3545;
        opacity: 0.7;
    }

    .reservation-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .reservation-body {
        padding: 20px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .status-programada { background: #17a2b8; }
    .status-activa { 
        background: #28a745; 
        animation: pulse-green 2s infinite;
    }
    .status-completada { background: #6c757d; }
    .status-cancelada { background: #dc3545; }

    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    .time-badge {
        background: var(--sena-orange);
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .time-badge.past {
        background: #6c757d;
    }

    .time-badge.active {
        background: #28a745;
        animation: pulse-badge 1.5s infinite;
    }

    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .calendar-view {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .calendar-day {
        background: white;
        padding: 15px 10px;
        text-align: center;
        min-height: 80px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .calendar-day:hover {
        background: #f8f9fa;
    }

    .calendar-day.other-month {
        background: #f8f9fa;
        color: #6c757d;
    }

    .calendar-day.today {
        background: var(--sena-green);
        color: white;
    }

    .calendar-day.has-reservations {
        background: #e3f2fd;
    }

    .calendar-event {
        background: var(--sena-orange);
        color: white;
        font-size: 0.7rem;
        padding: 2px 5px;
        border-radius: 3px;
        margin-top: 2px;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .quick-filters {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    .filter-button {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 8px 15px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        font-size: 0.9rem;
    }

    .filter-button:hover, .filter-button.active {
        background: var(--sena-green);
        border-color: var(--sena-green);
        color: white;
    }

    .reservation-timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        padding: 15px 0;
        border-left: 2px solid #dee2e6;
    }

    .timeline-item:last-child {
        border-left: none;
    }

    .timeline-dot {
        position: absolute;
        left: -6px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--sena-green);
        border: 2px solid white;
        box-shadow: 0 0 0 2px #dee2e6;
    }

    .equipment-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }

    .user-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--sena-green);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 10px;
    }

    .reservation-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn-action {
        flex: 1;
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .stats-row {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-light-green) 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }
        
        .calendar-day {
            padding: 8px 5px;
            min-height: 60px;
        }
        
        .reservation-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">Gestión de Reservas</h2>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        {{ reservas|length }} reservas registradas
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sena" data-bs-toggle="modal" data-bs-target="#newReservationModal">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nueva Reserva
                    </button>
                    <div class="view-toggle">
                        <button class="btn active" id="listView" onclick="toggleView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                        <button class="btn" id="calendarView" onclick="toggleView('calendar')">
                            <i class="bi bi-calendar3"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="stats-row">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">{{ reservas|selectattr('estado', 'equalto', 'programada')|list|length }}</h3>
                    <small>Programadas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">{{ reservas|selectattr('estado', 'equalto', 'activa')|list|length }}</h3>
                    <small>Activas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">{{ reservas|selectattr('estado', 'equalto', 'completada')|list|length or 0 }}</h3>
                    <small>Completadas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">{{ reservas|length }}</h3>
                    <small>Total</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="quick-filters">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">Filtros Rápidos:</h6>
            </div>
            <div>
                <span class="filter-button active" data-filter="all">Todas</span>
                <span class="filter-button" data-filter="programada">Programadas</span>
                <span class="filter-button" data-filter="activa">Activas</span>
                <span class="filter-button" data-filter="hoy">Hoy</span>
                <span class="filter-button" data-filter="semana">Esta Semana</span>
                <span class="filter-button" data-filter="mis-reservas">Mis Reservas</span>
            </div>
        </div>
    </div>

    <!-- List View -->
    <div id="reservationsList">
        {% for reserva in reservas %}
        <div class="reservation-card {{ reserva.estado }}" 
             data-status="{{ reserva.estado }}" 
             data-user="{{ reserva.usuario_nombre }}"
             data-date="{{ reserva.fecha_inicio }}">
            
            <div class="reservation-header">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <div class="user-avatar-small">
                            {{ reserva.usuario_nombre[0]|upper }}
                        </div>
                        <div>
                            <h6 class="mb-0">{{ reserva.usuario_nombre }}</h6>
                            <small class="text-muted">ID: {{ reserva.id }}</small>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <span class="status-indicator status-{{ reserva.estado }}"></span>
                    <span class="badge bg-{{ 'info' if reserva.estado == 'programada' else 'success' if reserva.estado == 'activa' else 'secondary' }}">
                        {{ reserva.estado|title }}
                    </span>
                </div>
            </div>

            <div class="reservation-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="equipment-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-gear fs-3 text-primary me-3"></i>
                                <div>
                                    <h5 class="mb-1">{{ reserva.equipo_nombre }}</h5>
                                    <p class="text-muted mb-0">Equipo de laboratorio</p>
                                </div>
                            </div>
                        </div>

                        {% if reserva.observaciones %}
                        <div class="mt-3">
                            <h6 class="text-muted">Observaciones:</h6>
                            <p class="mb-0">{{ reserva.observaciones }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="text-end">
                            <div class="mb-2">
                                <i class="bi bi-calendar-event me-2"></i>
                                <strong>{{ reserva.fecha_inicio|strftime('%d/%m/%Y') }}</strong>
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-clock me-2"></i>
                                {{ reserva.fecha_inicio|strftime('%H:%M') }} - {{ reserva.fecha_fin|strftime('%H:%M') }}
                            </div>
                            <div class="mb-3">
                                {% set now = moment() %}
                                {% set start_time = reserva.fecha_inicio|strptime('%Y-%m-%d %H:%M:%S') %}
                                {% set end_time = reserva.fecha_fin|strptime('%Y-%m-%d %H:%M:%S') %}
                                
                                {% if start_time > now %}
                                <span class="time-badge">En {{ ((start_time - now).total_seconds() / 3600)|int }} horas</span>
                                {% elif start_time <= now <= end_time %}
                                <span class="time-badge active">En curso</span>
                                {% else %}
                                <span class="time-badge past">Finalizada</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="reservation-actions">
                            {% if reserva.estado == 'programada' %}
                            <button class="btn btn-action btn-success btn-sm" onclick="startReservation('{{ reserva.id }}')">
                                <i class="bi bi-play-circle me-1"></i>
                                Iniciar
                            </button>
                            <button class="btn btn-action btn-danger btn-sm" onclick="cancelReservation('{{ reserva.id }}')">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar
                            </button>
                            {% elif reserva.estado == 'activa' %}
                            <button class="btn btn-action btn-warning btn-sm" onclick="finishReservation('{{ reserva.id }}')">
                                <i class="bi bi-stop-circle me-1"></i>
                                Finalizar
                            </button>
                            <button class="btn btn-action btn-info btn-sm" onclick="extendReservation('{{ reserva.id }}')">
                                <i class="bi bi-clock me-1"></i>
                                Extender
                            </button>
                            {% else %}
                            <button class="btn btn-action btn-outline-secondary btn-sm" onclick="viewReservationDetails('{{ reserva.id }}')">
                                <i class="bi bi-eye me-1"></i>
                                Ver Detalles
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Calendar View -->
    <div id="reservationsCalendar" class="calendar-view d-none">
        <div class="calendar-header">
            <h5 class="mb-0">
                <span id="currentMonth">Enero 2025</span>
            </h5>
            <div>
                <button class="btn btn-outline-secondary btn-sm" onclick="previousMonth()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="nextMonth()">
                    <i class="bi bi-chevron-right"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm ms-2" onclick="goToToday()">
                    Hoy
                </button>
            </div>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar will be generated by JavaScript -->
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noReservations" class="text-center py-5 d-none">
        <i class="bi bi-calendar-x display-1 text-muted"></i>
        <h4 class="mt-3">No se encontraron reservas</h4>
        <p class="text-muted">Intente modificar los filtros o crear una nueva reserva</p>
    </div>
</div>

<!-- New Reservation Modal -->
<div class="modal fade" id="newReservationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nueva Reserva de Equipo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newReservationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="equipmentSelect" class="form-label">Equipo</label>
                                <select class="form-control" id="equipmentSelect" name="equipo_id" required>
                                    <option value="">Seleccionar equipo...</option>
                                    <!-- This would be populated from available equipment -->
                                    <option value="EQ001">Microscopio Óptico - Lab A</option>
                                    <option value="EQ002">Balanza Analítica - Lab B</option>
                                    <option value="EQ003">Espectrofotómetro - Lab C</option>
                                    <option value="EQ004">pH Metro Digital - Lab A</option>
                                    <option value="EQ005">Centrífuga - Lab B</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reservationDate" class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="reservationDate" name="fecha" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" id="startTime" name="hora_inicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">Hora de Fin</label>
                                <input type="time" class="form-control" id="endTime" name="hora_fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="purpose" class="form-label">Propósito de Uso</label>
                        <select class="form-control" id="purpose" name="proposito" required>
                            <option value="">Seleccionar propósito...</option>
                            <option value="practica">Práctica de Laboratorio</option>
                            <option value="investigacion">Investigación</option>
                            <option value="proyecto">Proyecto de Grado</option>
                            <option value="capacitacion">Capacitación</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="calibracion">Calibración</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observations" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observations" name="observaciones" rows="3" placeholder="Detalles específicos, precauciones, materiales necesarios, etc."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recurring" name="recurring">
                            <label class="form-check-label" for="recurring">
                                Reserva recurrente (semanal)
                            </label>
                        </div>
                    </div>
                    
                    <div id="recurringOptions" class="mb-3 d-none">
                        <label for="recurringWeeks" class="form-label">Repetir por (semanas)</label>
                        <input type="number" class="form-control" id="recurringWeeks" name="recurring_weeks" min="1" max="12" value="4">
                    </div>
                </form>
                
                <!-- Equipment Availability Display -->
                <div class="equipment-availability mt-4 p-3 bg-light rounded">
                    <h6>Disponibilidad del Equipo</h6>
                    <div id="availabilityInfo">
                        <p class="text-muted">Seleccione un equipo para ver su disponibilidad</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-sena" onclick="submitReservation()">
                    <i class="bi bi-check-circle me-2"></i>
                    Crear Reserva
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Extend Reservation Modal -->
<div class="modal fade" id="extendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock me-2"></i>
                    Extender Reserva
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="extendForm">
                    <input type="hidden" id="extendReservationId" name="reservation_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Reserva</label>
                        <input type="text" class="form-control" id="extendReservationInfo" readonly>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="currentEndTime" class="form-label">Fin Actual</label>
                                <input type="time" class="form-control" id="currentEndTime" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newEndTime" class="form-label">Nueva Hora de Fin</label>
                                <input type="time" class="form-control" id="newEndTime" name="new_end_time" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="extendReason" class="form-label">Motivo de Extensión</label>
                        <textarea class="form-control" id="extendReason" name="reason" rows="2" placeholder="Explique por qué necesita extender la reserva" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="submitExtension()">
                    <i class="bi bi-check-circle me-2"></i>
                    Extender Reserva
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentView = 'list';
    let currentDate = new Date();
    let reservationsData = {{ reservas|tojson }};
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeFilters();
        setupFormDefaults();
        setupEquipmentSelect();
        
        // Show calendar if specified
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === 'calendar') {
            toggleView('calendar');
        }
    });

    function initializeFilters() {
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                filterReservations(this.dataset.filter);
            });
        });
    }

    function filterReservations(filter) {
        const reservationCards = document.querySelectorAll('.reservation-card');
        let visibleCount = 0;
        const today = new Date();
        const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
        const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
        
        reservationCards.forEach(card => {
            const status = card.dataset.status;
            const user = card.dataset.user;
            const dateStr = card.dataset.date;
            const reservationDate = new Date(dateStr);
            
            let shouldShow = false;
            
            switch(filter) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'programada':
                case 'activa':
                case 'completada':
                case 'cancelada':
                    shouldShow = status === filter;
                    break;
                case 'hoy':
                    shouldShow = reservationDate.toDateString() === new Date().toDateString();
                    break;
                case 'semana':
                    shouldShow = reservationDate >= startOfWeek && reservationDate <= endOfWeek;
                    break;
                case 'mis-reservas':
                    shouldShow = user === '{{ user.user_name }}';
                    break;
            }
            
            if (shouldShow) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        const noResults = document.getElementById('noReservations');
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
    }

    function toggleView(view) {
        const listView = document.getElementById('reservationsList');
        const calendarViewDiv = document.getElementById('reservationsCalendar');
        const listBtn = document.getElementById('listView');
        const calendarBtn = document.getElementById('calendarView');
        
        if (view === 'list') {
            listView.classList.remove('d-none');
            calendarViewDiv.classList.add('d-none');
            listBtn.classList.add('active');
            calendarBtn.classList.remove('active');
        } else {
            listView.classList.add('d-none');
            calendarViewDiv.classList.remove('d-none');
            listBtn.classList.remove('active');
            calendarBtn.classList.add('active');
            generateCalendar();
        }
        
        currentView = view;
    }

    function generateCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Update month display
        document.getElementById('currentMonth').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        // Clear calendar
        calendarGrid.innerHTML = '';
        
        // Add day headers
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day text-center fw-bold';
            dayHeader.style.backgroundColor = '#f8f9fa';
            dayHeader.style.minHeight = '40px';
            dayHeader.style.display = 'flex';
            dayHeader.style.alignItems = 'center';
            dayHeader.style.justifyContent = 'center';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });
        
        // Get first day of month and number of days
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        // Generate calendar days
        for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);
            
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            
            // Add classes for styling
            if (cellDate.getMonth() !== currentDate.getMonth()) {
                dayCell.classList.add('other-month');
            }
            if (cellDate.toDateString() === new Date().toDateString()) {
                dayCell.classList.add('today');
            }
            
            // Add day number
            const dayNumber = document.createElement('div');
            dayNumber.textContent = cellDate.getDate();
            dayCell.appendChild(dayNumber);
            
            // Add reservations for this day
            const dayReservations = reservationsData.filter(reservation => {
                const reservationDate = new Date(reservation.fecha_inicio);
                return reservationDate.toDateString() === cellDate.toDateString();
            });
            
            if (dayReservations.length > 0) {
                dayCell.classList.add('has-reservations');
                dayReservations.slice(0, 3).forEach(reservation => { // Show max 3 events
                    const event = document.createElement('div');
                    event.className = 'calendar-event';
                    event.textContent = reservation.equipo_nombre;
                    event.title = `${reservation.equipo_nombre} - ${reservation.usuario_nombre}`;
                    dayCell.appendChild(event);
                });
                
                if (dayReservations.length > 3) {
                    const moreEvents = document.createElement('div');
                    moreEvents.className = 'calendar-event';
                    moreEvents.style.background = '#6c757d';
                    moreEvents.textContent = `+${dayReservations.length - 3} más`;
                    dayCell.appendChild(moreEvents);
                }
            }
            
            // Add click handler
            dayCell.addEventListener('click', () => showDayReservations(cellDate));
            
            calendarGrid.appendChild(dayCell);
        }
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        generateCalendar();
    }

    function showDayReservations(date) {
        const dayReservations = reservationsData.filter(reservation => {
            const reservationDate = new Date(reservation.fecha_inicio);
            return reservationDate.toDateString() === date.toDateString();
        });
        
        if (dayReservations.length > 0) {
            toggleView('list');
            // Filter to show only that day's reservations
            document.querySelector('[data-filter="hoy"]').click();
        } else {
            // Open new reservation modal with pre-filled date
            document.getElementById('reservationDate').value = date.toISOString().split('T')[0];
            const modal = new bootstrap.Modal(document.getElementById('newReservationModal'));
            modal.show();
        }
    }

    function setupFormDefaults() {
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('reservationDate').value = tomorrow.toISOString().split('T')[0];
        
        // Set default time slots
        document.getElementById('startTime').value = '08:00';
        document.getElementById('endTime').value = '10:00';
        
        // Recurring checkbox handler
        document.getElementById('recurring').addEventListener('change', function() {
            const recurringOptions = document.getElementById('recurringOptions');
            if (this.checked) {
                recurringOptions.classList.remove('d-none');
            } else {
                recurringOptions.classList.add('d-none');
            }
        });
    }

    function setupEquipmentSelect() {
        const equipmentSelect = document.getElementById('equipmentSelect');
        equipmentSelect.addEventListener('change', function() {
            if (this.value) {
                showEquipmentAvailability(this.value);
            } else {
                document.getElementById('availabilityInfo').innerHTML = '<p class="text-muted">Seleccione un equipo para ver su disponibilidad</p>';
            }
        });
    }

    function showEquipmentAvailability(equipmentId) {
        const availabilityInfo = document.getElementById('availabilityInfo');
        
        // Simulate availability check
        availabilityInfo.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong>Disponible en el horario seleccionado</strong>
            </div>
            <small class="text-muted">
                Próximas reservas: Mañana 14:00-16:00, Viernes 09:00-11:00
            </small>
        `;
    }

    function submitReservation() {
        const form = document.getElementById('newReservationForm');
        const formData = new FormData(form);
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const reservationData = {
            equipo_id: formData.get('equipo_id'),
            fecha_inicio: `${formData.get('fecha')} ${formData.get('hora_inicio')}`,
            fecha_fin: `${formData.get('fecha')} ${formData.get('hora_fin')}`,
            proposito: formData.get('proposito'),
            observaciones: formData.get('observaciones'),
            recurrente: formData.get('recurring') ? true : false,
            semanas_recurrencia: formData.get('recurring_weeks') || 1
        };
        
        // Show loading state
        const submitBtn = event.target;
        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando...';
        submitBtn.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            showToast('Reserva creada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('newReservationModal'));
            modal.hide();
            
            // Reset form
            form.reset();
            setupFormDefaults();
            
            // Refresh page in real implementation
            setTimeout(() => window.location.reload(), 1500);
            
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
        }, 1500);
    }

    function startReservation(reservationId) {
        showToast('Iniciando reserva...', 'info');
        
        // Simulate API call
        setTimeout(() => {
            showToast('Reserva iniciada exitosamente', 'success');
            // Update card status
            updateReservationStatus(reservationId, 'activa');
        }, 1000);
    }

    function cancelReservation(reservationId) {
        if (confirm('¿Está seguro de que desea cancelar esta reserva?')) {
            showToast('Cancelando reserva...', 'info');
            
            setTimeout(() => {
                showToast('Reserva cancelada exitosamente', 'success');
                updateReservationStatus(reservationId, 'cancelada');
            }, 1000);
        }
    }

    function finishReservation(reservationId) {
        if (confirm('¿Confirma que ha terminado de usar el equipo?')) {
            showToast('Finalizando reserva...', 'info');
            
            setTimeout(() => {
                showToast('Reserva finalizada exitosamente', 'success');
                updateReservationStatus(reservationId, 'completada');
            }, 1000);
        }
    }

    function extendReservation(reservationId) {
        // Find reservation data
        const reservation = reservationsData.find(r => r.id === reservationId);
        if (reservation) {
            document.getElementById('extendReservationId').value = reservationId;
            document.getElementById('extendReservationInfo').value = `${reservation.equipo_nombre} - ${reservation.usuario_nombre}`;
            document.getElementById('currentEndTime').value = new Date(reservation.fecha_fin).toTimeString().slice(0, 5);
            
            // Set minimum new end time (current end time + 30 minutes)
            const currentEnd = new Date(reservation.fecha_fin);
            currentEnd.setMinutes(currentEnd.getMinutes() + 30);
            document.getElementById('newEndTime').value = currentEnd.toTimeString().slice(0, 5);
            
            const modal = new bootstrap.Modal(document.getElementById('extendModal'));
            modal.show();
        }
    }

    function submitExtension() {
        const form = document.getElementById('extendForm');
        const formData = new FormData(form);
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const submitBtn = event.target;
        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Extendiendo...';
        submitBtn.disabled = true;
        
        setTimeout(() => {
            showToast('Reserva extendida exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('extendModal'));
            modal.hide();
            
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
        }, 1500);
    }

    function viewReservationDetails(reservationId) {
        showToast('Cargando detalles de la reserva...', 'info');
        // In real implementation, show detailed modal
    }

    function updateReservationStatus(reservationId, newStatus) {
        const card = document.querySelector(`[data-status] input[value="${reservationId}"]`)?.closest('.reservation-card');
        if (card) {
            card.dataset.status = newStatus;
            card.className = `reservation-card ${newStatus}`;
            
            // Update status badge
            const statusBadge = card.querySelector('.badge');
            statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            statusBadge.className = `badge bg-${'info' if newStatus === 'programada' else 'success' if newStatus === 'activa' else 'secondary'}`;
            
            // Update status indicator
            const indicator = card.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${newStatus}`;
            
            // Update actions
            updateReservationActions(card, newStatus);
        }
    }

    function updateReservationActions(card, status) {
        const actionsDiv = card.querySelector('.reservation-actions');
        let actionsHTML = '';
        
        switch(status) {
            case 'programada':
                actionsHTML = `
                    <button class="btn btn-action btn-success btn-sm" onclick="startReservation('${card.dataset.id}')">
                        <i class="bi bi-play-circle me-1"></i> Iniciar
                    </button>
                    <button class="btn btn-action btn-danger btn-sm" onclick="cancelReservation('${card.dataset.id}')">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                `;
                break;
            case 'activa':
                actionsHTML = `
                    <button class="btn btn-action btn-warning btn-sm" onclick="finishReservation('${card.dataset.id}')">
                        <i class="bi bi-stop-circle me-1"></i> Finalizar
                    </button>
                    <button class="btn btn-action btn-info btn-sm" onclick="extendReservation('${card.dataset.id}')">
                        <i class="bi bi-clock me-1"></i> Extender
                    </button>
                `;
                break;
            default:
                actionsHTML = `
                    <button class="btn btn-action btn-outline-secondary btn-sm" onclick="viewReservationDetails('${card.dataset.id}')">
                        <i class="bi bi-eye me-1"></i> Ver Detalles
                    </button>
                `;
        }
        
        actionsDiv.innerHTML = actionsHTML;
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    // Real-time reservation status updates
    function checkActiveReservations() {
        const now = new Date();
        const activeCards = document.querySelectorAll('[data-status="activa"]');
        
        activeCards.forEach(card => {
            const endTimeStr = card.querySelector('[data-date]')?.dataset.date;
            if (endTimeStr) {
                const endTime = new Date(endTimeStr);
                if (now > endTime) {
                    // Auto-complete expired reservations
                    updateReservationStatus(card.dataset.id, 'completada');
                    showToast('Reserva completada automáticamente', 'info');
                }
            }
        });
    }

    // Check every minute for expired reservations
    setInterval(checkActiveReservations, 60000);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    const newModal = new bootstrap.Modal(document.getElementById('newReservationModal'));
                    newModal.show();
                    break;
                case 'v':
                    e.preventDefault();
                    toggleView(currentView === 'list' ? 'calendar' : 'list');
                    break;
            }
        }
    });

    // Voice command integration
    document.addEventListener('voiceCommand', function(e) {
        const command = e.detail.command.toLowerCase();
        
        if (command.includes('nueva reserva') || command.includes('reservar')) {
            const modal = new bootstrap.Modal(document.getElementById('newReservationModal'));
            modal.show();
        } else if (command.includes('calendario')) {
            toggleView('calendar');
        } else if (command.includes('lista')) {
            toggleView('list');
        } else if (command.includes('mis reservas')) {
            document.querySelector('[data-filter="mis-reservas"]').click();
        } else if (command.includes('hoy')) {
            document.querySelector('[data-filter="hoy"]').click();
        }
    });
</script>
{% endblock %}